openapi: 3.1.0
info:
  title: Authentication Service API
  version: 1.0.0
  description: Authentication microservice for Ecommerce API

servers:
  - url: http://localhost:8000/
    description: Authentication service

tags:
  - name: Auth
    description: Authentication & token endpoints
  - name: Users
    description: User management endpoints
  - name: Health
    description: Service health endpoints
  - name: Root
    description: Root information
  - name: Testing
    description: Testing endpoints

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: Service health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  redis:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
                  environment:
                    type: string
                required:
                  - status
                  - service
                  - redis
                  - timestamp
                  - environment

  /info:
    get:
      tags: [Root]
      summary: Service information
      responses:
        "200":
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  version:
                    type: string
                  environment:
                    type: string
                  docs:
                    type: string
                  health:
                    type: string
                required:
                  - message
                  - version
                  - environment
                  - docs
                  - health

  /register:
    post:
      tags: [Auth]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/User"
      responses:
        "201":
          description: User created
          headers:
            Location:
              description: URI of created user
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /login:
    post:
      tags: [Auth]
      summary: Login user (returns access + refresh tokens)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Tokens returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "429":
          description: Rate limit exceeded
        "500":
          $ref: "#/components/responses/InternalError"

  /refresh-token:
    post:
      tags: [Auth]
      summary: Refresh access token using refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequest"
      responses:
        "200":
          description: New access token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccessTokenResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /logout:
    post:
      tags: [Auth]
      summary: Logout user (revoke refresh token)
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Logged out
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /me:
    get:
      tags: [Auth]
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /users/{user_id}/generate-referral:
    post:
      tags: [Users]
      summary: Generate referral code for user
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Referral code generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReferralCodeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /users/referrer/{referral_code}:
    get:
      tags: [Users]
      summary: Get referrer info by referral code
      parameters:
        - name: referral_code
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Referrer information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReferrerResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /users/{user_id}/referrals:
    get:
      tags: [Users]
      summary: Get all users referred by this user
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User referrals
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserReferralsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /users/{user_id}/commission-report:
    get:
      tags: [Users]
      summary: Get commission report for a user
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Commission report
          content:
            application/json:
              schema:
                type: object
                properties:
                  referrer_id:
                    type: string
                  total_commissions:
                    type: integer
                  total_amount:
                    type: number
                    format: float
                  pending_amount:
                    type: number
                    format: float
                  paid_amount:
                    type: number
                    format: float
                  commissions:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        order_id:
                          type: string
                        amount:
                          type: number
                        status:
                          type: string
                        created_at:
                          type: string
                required:
                  - referrer_id
                  - total_commissions
                  - total_amount
                  - pending_amount
                  - paid_amount
                  - commissions
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /cleanup-test-data:
    delete:
      tags: [Testing]
      summary: Cleanup test data (for k6 testing)
      responses:
        "204":
          description: Test data cleaned up
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
          description: Must be at least 8 characters, contain uppercase, lowercase, digit, and special character
        name:
          type: string
          minLength: 1
        referral_code:
          type: string
          nullable: true
          description: Optional referral code for signup
      required:
        - email
        - password
        - name

    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required:
        - email
        - password

    RefreshTokenRequest:
      type: object
      properties:
        refreshToken:
          type: string
      required:
        - refreshToken

    PasswordChangeRequest:
      type: object
      properties:
        oldPassword:
          type: string
        newPassword:
          type: string
          minLength: 8
      required:
        - oldPassword
        - newPassword

    UserResponse:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        name:
          type: string
        referred_by:
          type: string
          nullable: true
        referral_code:
          type: string
          nullable: true
        referral_created_at:
          type: string
          format: date-time
          nullable: true
      required:
        - id
        - email
        - name

    TokenResponse:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
      required:
        - accessToken
        - refreshToken

    AccessTokenResponse:
      type: object
      properties:
        accessToken:
          type: string
      required:
        - accessToken

    ReferralCodeResponse:
      type: object
      properties:
        referral_code:
          type: string
        message:
          type: string
          default: "Referral code generated"
        share_url:
          type: string
          nullable: true
      required:
        - referral_code
        - message

    ReferrerResponse:
      type: object
      properties:
        referrer_id:
          type: string
        referrer_email:
          type: string
          format: email
        referrer_name:
          type: string
        referral_code:
          type: string
      required:
        - referrer_id
        - referrer_email
        - referrer_name
        - referral_code

    ReferredUserResponse:
      type: object
      properties:
        user_id:
          type: string
        email:
          type: string
          format: email
        name:
          type: string
        created_at:
          type: string
          format: date-time
      required:
        - user_id
        - email
        - name
        - created_at

    UserReferralsResponse:
      type: object
      properties:
        referrer_id:
          type: string
        total_referrals:
          type: integer
        referrals:
          type: array
          items:
            $ref: "#/components/schemas/ReferredUserResponse"
      required:
        - referrer_id
        - total_referrals
        - referrals

    ProblemDetails:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri
          nullable: true
      required:
        - type
        - title
        - status
        - detail

  responses:
    BadRequest:
      description: Bad request
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Unauthorized:
      description: Unauthorized
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Forbidden:
      description: Forbidden
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    NotFound:
      description: Not Found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Conflict:
      description: Conflict
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    UnprocessableEntity:
      description: Validation error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    InternalError:
      description: Internal Server Error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"