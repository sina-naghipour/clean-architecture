openapi: 3.1.0
info:
  title: E-commerce Platform API
  version: 2.0.0
  description: Complete e-commerce platform with microservices architecture
  contact:
    name: API Team
    email: api@example.com

servers:
  - url: https://api.example.com/v2
    description: Production API
  - url: http://localhost:8080/v2
    description: Local development
  - url: http://localhost:8000
    description: Authentication service
  - url: http://localhost:8001
    description: Payments service
  - url: http://localhost:8003
    description: Products service
  - url: http://localhost:8005
    description: Static files service

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Products
    description: Product catalog and inventory management
  - name: Orders
    description: Order management and processing
  - name: Payments
    description: Payment processing and webhooks
  - name: Static Files
    description: File upload and management
  - name: Health
    description: Service health monitoring
  - name: Admin
    description: Administrative operations

paths:
  # ============ AUTHENTICATION ENDPOINTS ============
  /auth/health:
    get:
      tags: [Health]
      summary: Authentication service health
      responses:
        "200":
          description: Service health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  timestamp:
                    type: string
                  environment:
                    type: string

  /auth/info:
    get:
      tags: [Authentication]
      summary: Authentication service info
      responses:
        "200":
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  version:
                    type: string
                  environment:
                    type: string
                  docs:
                    type: string
                  health:
                    type: string

  /auth/register:
    post:
      tags: [Authentication]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                name:
                  type: string
                  minLength: 1
              required:
                - email
                - password
                - name
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  email:
                    type: string
                  name:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: User already exists
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/login:
    post:
      tags: [Authentication]
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required:
                - email
                - password
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/refresh-token:
    post:
      tags: [Authentication]
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
              required:
                - refreshToken
      responses:
        "200":
          description: New access token
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/logout:
    post:
      tags: [Authentication]
      summary: Logout user
      security:
        - BearerAuth: []
      responses:
        "204":
          description: Logged out successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/me:
    get:
      tags: [Authentication]
      summary: Get current user profile
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  email:
                    type: string
                  name:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ============ PRODUCTS ENDPOINTS ============
  /products/health:
    get:
      tags: [Health]
      summary: Products service health
      responses:
        "200":
          description: Service health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  service:
                    type: string
                    example: "product"
                  timestamp:
                    type: string
                    format: date-time
                  environment:
                    type: string
                    example: "development"

  /products/info:
    get:
      tags: [Products]
      summary: Products service info
      responses:
        "200":
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Ecommerce Product Service"
                  version:
                    type: string
                    example: "1.0.0"
                  environment:
                    type: string
                    example: "development"
                  docs:
                    type: string
                    example: "/docs"
                  health:
                    type: string
                    example: "/health"

  /products:
    get:
      tags: [Products]
      summary: List products with pagination
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: q
          in: query
          schema:
            type: string
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
        - name: min_price
          in: query
          schema:
            type: number
            minimum: 0
        - name: max_price
          in: query
          schema:
            type: number
            minimum: 0
      responses:
        "200":
          description: Products list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductList"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags: [Products]
      summary: Create product
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductRequest"
      responses:
        "201":
          description: Product created
          headers:
            Location:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Product name exists
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/with-images:
    post:
      tags: [Products]
      summary: Create product with images
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                name:
                  type: string
                price:
                  type: number
                stock:
                  type: integer
                description:
                  type: string
                tags:
                  type: array
                  items:
                    type: string
                images:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        "201":
          description: Product created with images
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/{product_id}:
    get:
      tags: [Products]
      summary: Get product details
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags: [Products]
      summary: Update product fully
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductRequest"
      responses:
        "200":
          description: Product updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Name conflict
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

    patch:
      tags: [Products]
      summary: Partially update product
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductPatch"
      responses:
        "200":
          description: Product patched
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Products]
      summary: Delete product
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Product deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/{product_id}/inventory:
    patch:
      tags: [Products]
      summary: Update product stock
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InventoryUpdate"
      responses:
        "200":
          description: Inventory updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/{product_id}/images:
    post:
      tags: [Products]
      summary: Add images to product
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                images:
                  type: array
                  items:
                    type: string
                    format: binary
                  minItems: 1
                  maxItems: 10
      responses:
        "200":
          description: Images added
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_id:
                    type: string
                  added_count:
                    type: integer
                  failed_count:
                    type: integer
                  total_images:
                    type: integer
                  new_images:
                    type: array
                    items:
                      type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Products]
      summary: Remove image from product
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: image_url
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Image removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_id:
                    type: string
                  removed_image:
                    type: string
                  remaining_images:
                    type: array
                    items:
                      type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/{product_id}/images/cleanup:
    post:
      tags: [Admin]
      summary: Clean up invalid product images
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Images cleaned up
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_id:
                    type: string
                  valid_images:
                    type: integer
                  invalid_images_removed:
                    type: integer
                  invalid_image_urls:
                    type: array
                    items:
                      type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/{product_id}/tags:
    patch:
      tags: [Products]
      summary: Update product tags
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductTagUpdate"
      responses:
        "200":
          description: Tags updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  product_id:
                    type: string
                  updated_tags:
                    type: array
                    items:
                      type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/routes:
    get:
      tags: [Products]
      summary: List API routes
      responses:
        "200":
          description: Routes list
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                  total_routes:
                    type: integer
                  routes:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        methods:
                          type: array
                          items:
                            type: string
                        name:
                          type: string
                          nullable: true
                        endpoint:
                          type: string
                          nullable: true

  # ============ STATIC FILES ENDPOINTS ============
  /static/:
    get:
      tags: [Static Files]
      summary: Static service info
      responses:
        "200":
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: "static-file-service"
                  version:
                    type: string
                    example: "1.0.0"
                  endpoints:
                    type: object
                    properties:
                      upload:
                        type: string
                        example: "POST /files"
                      batch_upload:
                        type: string
                        example: "POST /files/batch"
                      download:
                        type: string
                        example: "GET /files/{file_id}"
                      delete:
                        type: string
                        example: "DELETE /files/{file_id}"
                      metadata:
                        type: string
                        example: "GET /metadata"
                      health:
                        type: string
                        example: "GET /health"
                      docs:
                        type: string
                        example: "/docs"

  /static/health:
    get:
      tags: [Health]
      summary: Static service health
      responses:
        "200":
          description: Service health
          content:
            application/json:
              schema:
                type: object
                properties:
                  upload_dir_exists:
                    type: boolean
                  upload_dir_writable:
                    type: boolean
                  metadata_file_exists:
                    type: boolean
                  service:
                    type: string
                  status:
                    type: string
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

  /static/files:
    post:
      tags: [Static Files]
      summary: Upload single file
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                subdirectory:
                  type: string
                  default: "general"
                custom_metadata:
                  type: string
      responses:
        "201":
          description: File uploaded
          headers:
            Location:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileUploadSuccess"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "413":
          $ref: "#/components/responses/FileTooLarge"
        "415":
          $ref: "#/components/responses/UnsupportedMediaType"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /static/files/batch:
    post:
      tags: [Static Files]
      summary: Upload multiple files
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
                subdirectory:
                  type: string
                  default: "general"
      responses:
        "207":
          description: Batch upload result
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/MultiStatusResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "413":
          $ref: "#/components/responses/FileTooLarge"
        "415":
          $ref: "#/components/responses/UnsupportedMediaType"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /static/files/{file_id}:
    get:
      tags: [Static Files]
      summary: Download file
      security:
        - BearerAuth: []
      parameters:
        - name: file_id
          in: path
          required: true
          schema:
            type: string
            pattern: "^[a-f0-9]{32}$"
      responses:
        "200":
          description: File content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Static Files]
      summary: Delete file
      security:
        - BearerAuth: []
      parameters:
        - name: file_id
          in: path
          required: true
          schema:
            type: string
            pattern: "^[a-f0-9]{32}$"
      responses:
        "204":
          description: File deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /static/metadata:
    get:
      tags: [Static Files]
      summary: Get file metadata
      security:
        - BearerAuth: []
      parameters:
        - name: subdirectory
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Metadata list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetadataList"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  # ============ PAYMENTS ENDPOINTS ============
  /payments/health:
    get:
      tags: [Health]
      summary: Payments service health
      responses:
        "200":
          description: Service health
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  timestamp:
                    type: string
                  environment:
                    type: string
                  stripe_mode:
                    type: string
                  grpc_port:
                    type: integer

  /payments/ready:
    get:
      tags: [Health]
      summary: Payments service readiness
      responses:
        "200":
          description: Service ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  timestamp:
                    type: string
                  grpc_ready:
                    type: boolean

  /payments/info:
    get:
      tags: [Payments]
      summary: Payments service info
      responses:
        "200":
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  version:
                    type: string
                  environment:
                    type: string
                  stripe_mode:
                    type: string
                  ports:
                    type: object
                    properties:
                      http:
                        type: integer
                      grpc:
                        type: integer
                  docs:
                    type: string
                  health:
                    type: string
                  ready:
                    type: string

  /payments/webhooks/stripe:
    post:
      tags: [Payments]
      summary: Stripe webhook endpoint
      parameters:
        - name: Stripe-Signature
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  event:
                    type: string
                  reason:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /payments/routes:
    get:
      tags: [Payments]
      summary: List API routes
      responses:
        "200":
          description: Routes list
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                  total_routes:
                    type: integer
                  routes:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        methods:
                          type: array
                          items:
                            type: string
                        name:
                          type: string
                          nullable: true
                        endpoint:
                          type: string
                          nullable: true

  # ============ ORDERS ENDPOINTS ============
  /orders/health:
    get:
      tags: [Health]
      summary: Orders service health
      responses:
        "200":
          description: Service health
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  timestamp:
                    type: string
                  environment:
                    type: string

  /orders/ready:
    get:
      tags: [Health]
      summary: Orders service readiness
      responses:
        "200":
          description: Service ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  timestamp:
                    type: string

  /orders/info:
    get:
      tags: [Orders]
      summary: Orders service info
      responses:
        "200":
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  version:
                    type: string
                  environment:
                    type: string
                  docs:
                    type: string
                  health:
                    type: string
                  ready:
                    type: string

  /orders:
    post:
      tags: [Orders]
      summary: Create order
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderCreate"
      responses:
        "201":
          description: Order created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"
        "503":
          $ref: "#/components/responses/ServiceUnavailable"

    get:
      tags: [Orders]
      summary: List user orders
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: Orders list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderList"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /orders/{orderId}:
    get:
      tags: [Orders]
      summary: Get order details
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /orders/webhooks/payment-updates:
    post:
      tags: [Orders]
      summary: Payment webhook
      parameters:
        - name: X-API-Key
          in: header
          required: true
          schema:
            type: string
        - name: X-Idempotency-Key
          in: header
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                order_id:
                  type: string
                  format: uuid
                status:
                  type: string
                  enum: [succeeded, failed, refunded, canceled]
                receipt_url:
                  type: string
                payment_id:
                  type: string
              required:
                - order_id
                - status
      responses:
        "200":
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  order_id:
                    type: string
                  updated_status:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Duplicate request
        "500":
          $ref: "#/components/responses/InternalError"

components:
  schemas:
    # ============ COMMON SCHEMAS ============
    ProblemDetails:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri
      required:
        - type
        - title
        - status

    # ============ PRODUCTS SCHEMAS ============
    ProductRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        price:
          type: number
          minimum: 0
          exclusiveMinimum: true
        stock:
          type: integer
          minimum: 0
        description:
          type: string
          nullable: true
          maxLength: 1000
        tags:
          type: array
          items:
            type: string
          default: []
        images:
          type: array
          items:
            type: string
          default: []
      required:
        - name
        - price
        - stock

    ProductPatch:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          nullable: true
        price:
          type: number
          minimum: 0
          exclusiveMinimum: true
          nullable: true
        stock:
          type: integer
          minimum: 0
          nullable: true
        description:
          type: string
          nullable: true
          maxLength: 1000
        tags:
          type: array
          items:
            type: string
          nullable: true
        images:
          type: array
          items:
            type: string
          nullable: true

    ProductResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        price:
          type: number
        stock:
          type: integer
        description:
          type: string
          nullable: true
        tags:
          type: array
          items:
            type: string
        images:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - price
        - stock
        - tags
        - images
        - created_at
        - updated_at

    ProductList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/ProductResponse"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer
      required:
        - items
        - total
        - page
        - page_size

    InventoryUpdate:
      type: object
      properties:
        stock:
          type: integer
          minimum: 0
      required:
        - stock

    InventoryResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        stock:
          type: integer
      required:
        - id
        - stock

    ProductTagUpdate:
      type: object
      properties:
        tags:
          type: array
          items:
            type: string
          minItems: 1
      required:
        - tags

    ProductImageAdd:
      type: object
      properties:
        image_url:
          type: string
      required:
        - image_url

    # ============ STATIC FILES SCHEMAS ============
    FileUploadSuccess:
      type: object
      properties:
        id:
          type: string
          pattern: "^[a-f0-9]{32}$"
        filename:
          type: string
        original_filename:
          type: string
        path:
          type: string
        size:
          type: integer
        mime_type:
          type: string
          enum: ["image/jpeg", "image/png", "image/webp"]
        url:
          type: string
      required:
        - id
        - filename
        - original_filename
        - path
        - size
        - mime_type
        - url

    MultiStatusResponse:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri
        successful_count:
          type: integer
        failed_count:
          type: integer
        successful:
          type: array
          items:
            $ref: "#/components/schemas/FileUploadSuccess"
        failed:
          type: array
          items:
            $ref: "#/components/schemas/FailedUpload"
      required:
        - type
        - title
        - status
        - detail

    FailedUpload:
      type: object
      properties:
        filename:
          type: string
        error:
          type: string
        status_code:
          type: integer
        error_type:
          type: string
        title:
          type: string
      required:
        - filename
        - error
        - status_code

    MetadataList:
      type: object
      properties:
        files_count:
          type: integer
        files:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/FileMetadata"
      required:
        - files_count
        - files

    FileMetadata:
      type: object
      properties:
        original_filename:
          type: string
        safe_filename:
          type: string
        path:
          type: string
        full_path:
          type: string
        size_bytes:
          type: integer
        mime_type:
          type: string
          enum: ["image/jpeg", "image/png", "image/webp"]
        uploaded_at:
          type: string
          format: date-time
        custom_metadata:
          type: object
          additionalProperties: true
        id:
          type: string
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - original_filename
        - safe_filename
        - path
        - size_bytes
        - mime_type
        - uploaded_at

    # ============ ORDERS SCHEMAS ============
    OrderItemCreate:
      type: object
      properties:
        product_id:
          type: string
        name:
          type: string
        quantity:
          type: integer
          minimum: 1
        unit_price:
          type: number
          minimum: 0
      required:
        - product_id
        - name
        - quantity
        - unit_price

    OrderCreate:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItemCreate"
          minItems: 1
        billing_address_id:
          type: string
        shipping_address_id:
          type: string
        payment_method_token:
          type: string
      required:
        - items
        - billing_address_id
        - shipping_address_id
        - payment_method_token

    OrderItem:
      type: object
      properties:
        product_id:
          type: string
        name:
          type: string
        quantity:
          type: integer
        unit_price:
          type: number

    OrderResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [created, pending, paid, shipped, canceled, failed]
        total:
          type: number
        billing_address_id:
          type: string
          nullable: true
        shipping_address_id:
          type: string
          nullable: true
        payment_id:
          type: string
          nullable: true
        client_secret:
          type: string
          nullable: true
        receipt_url:
          type: string
          nullable: true
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"
        created_at:
          type: string
          format: date-time

    OrderList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderResponse"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer

  responses:
    BadRequest:
      description: Bad request
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Unauthorized:
      description: Authentication required
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Forbidden:
      description: Access denied
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Conflict:
      description: Resource conflict
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    UnprocessableEntity:
      description: Validation error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    InternalError:
      description: Internal server error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    ServiceUnavailable:
      description: Service unavailable
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    FileTooLarge:
      description: File exceeds size limit
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    UnsupportedMediaType:
      description: File type not allowed
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token from authentication service

    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for service-to-service communication

security:
  - BearerAuth: []