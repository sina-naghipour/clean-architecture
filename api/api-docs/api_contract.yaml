openapi: 3.1.0
info:
  title: Ecommerce API
  version: "1.1.0"
  description: Ecommerce API with Product Image Management
servers:
  - url: http://localhost:8000/api
  - url: http://localhost:8003/
tags:
  - name: Health
    description: Service health endpoints
  - name: Root
    description: Root information
  - name: Auth
    description: Authentication & token endpoints
  - name: Products
    description: Product catalog management
  - name: Product Images
    description: Secure product image management
  - name: Cart
    description: Per-user shopping cart
  - name: Orders
    description: Order lifecycle
  - name: Profile
    description: User profile and addresses

security:
  - bearerAuth: []

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: Service health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  timestamp:
                    type: string
                  environment:
                    type: string

  /ready:
    get:
      tags: [Health]
      summary: Readiness check
      responses:
        "200":
          description: Service readiness status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  timestamp:
                    type: string

  /info:
    get:
      tags: [Root]
      summary: Service information
      responses:
        "200":
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  version:
                    type: string
                  environment:
                    type: string
                  docs:
                    type: string
                  health:
                    type: string
                  ready:
                    type: string

  /auth/register:
    post:
      tags: [Auth]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
            examples:
              example:
                value:
                  email: "alice@example.com"
                  password: "S3cureP@ss"
                  name: "Alice"
      responses:
        "201":
          description: User created
          headers:
            Location:
              description: URI of created user
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
              examples:
                success:
                  value:
                    id: "user_123"
                    email: "alice@example.com"
                    name: "Alice"
        "400": 
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/login:
    post:
      tags: [Auth]
      summary: Login user (returns access + refresh tokens)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            examples:
              example:
                value:
                  email: "alice@example.com"
                  password: "S3cureP@ss"
      responses:
        "200":
          description: Tokens returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
              examples:
                success:
                  value:
                    accessToken: "eyJhbGciOi..."
                    refreshToken: "rft_abcdef"
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/refresh-token:
    post:
      tags: [Auth]
      summary: Refresh access token using refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequest"
            examples:
              example:
                value:
                  refreshToken: "rft_abcdef"
      responses:
        "200":
          description: New access token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccessTokenResponse"
              examples:
                success:
                  value:
                    accessToken: "eyJhbGciOi..."
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout user (revoke refresh token)
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Logged out
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /products:
    get:
      tags: [Products]
      summary: List products (supports paging & filtering)
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/pageSize"
        - in: query
          name: q
          schema:
            type: string
          description: Full-text search across name & description
        - in: query
          name: tags
          schema:
            type: array
            items:
              type: string
          description: Filter by tags
        - in: query
          name: min_price
          schema:
            type: number
            minimum: 0
          description: Minimum price filter
        - in: query
          name: max_price
          schema:
            type: number
            minimum: 0
          description: Maximum price filter
      responses:
        "200":
          description: Paginated product list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductList"
              examples:
                success:
                  value:
                    items:
                      - id: "prod_1"
                        name: "Laptop"
                        price: 1299.99
                        stock: 5
                        description: "High-performance laptop"
                        tags: ["electronics", "computer"]
                        images: ["/static/img/products/prod_1/image1.jpg"]
                        primaryImageId: "img_123"
                        created_at: "2023-10-01T12:00:00Z"
                        updated_at: "2023-10-01T12:00:00Z"
                    total: 1
                    page: 1
                    pageSize: 20
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags: [Products]
      summary: Create product (admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductRequest"
            examples:
              example:
                value:
                  name: "Wireless Mouse"
                  price: 29.99
                  stock: 100
                  description: "Ergonomic mouse"
                  tags: ["electronics", "peripheral"]
                  images: []
      responses:
        "201":
          description: Product created
          headers:
            Location:
              description: URI of created product
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
              examples:
                success:
                  value:
                    id: "prod_42"
                    name: "Wireless Mouse"
                    price: 29.99
                    stock: 100
                    description: "Ergonomic mouse"
                    tags: ["electronics", "peripheral"]
                    images: []
                    primaryImageId: null
                    created_at: "2023-10-01T12:00:00Z"
                    updated_at: "2023-10-01T12:00:00Z"
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/{productId}:
    parameters:
      - $ref: "#/components/parameters/ProductId"
    get:
      tags: [Products]
      summary: Get product details
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
              examples:
                success:
                  value:
                    id: "prod_42"
                    name: "Wireless Mouse"
                    price: 29.99
                    stock: 100
                    description: "Ergonomic mouse"
                    tags: ["electronics", "peripheral"]
                    images: ["/static/img/products/prod_42/image1.jpg"]
                    primaryImageId: "img_123"
                    created_at: "2023-10-01T12:00:00Z"
                    updated_at: "2023-10-01T12:00:00Z"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags: [Products]
      summary: Replace product (full update) — admin only
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductRequest"
      responses:
        "200":
          description: Product replaced
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

    patch:
      tags: [Products]
      summary: Partially update product (admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductPatch"
      responses:
        "200":
          description: Product updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductResponse"
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Products]
      summary: Delete product (admin)
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Product deleted
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /products/{productId}/inventory:
    parameters:
      - $ref: "#/components/parameters/ProductId"
    patch:
      tags: [Products]
      summary: Update product stock (admin) — idempotent
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InventoryUpdate"
            examples:
              example:
                value:
                  stock: 120
      responses:
        "200":
          description: Stock updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventoryResponse"
              examples:
                success:
                  value:
                    id: "prod_42"
                    stock: 120
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

  /files:
    post:
      tags: [Product Images]
      summary: Upload product image (admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Image file (JPEG, PNG, WebP) - max 5MB
                is_primary:
                  type: boolean
                  description: Set as primary product image
                  default: false
      responses:
        "201":
          description: Image uploaded successfully
          headers:
            Location:
              description: URI of created image
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductImage"
              examples:
                success:
                  value:
                    id: "img_12345678-1234-5678-1234-567812345678"
                    productId: "prod_42"
                    filename: "prod_42_abc123.jpg"
                    originalName: "mouse.jpg"
                    mimeType: "image/jpeg"
                    size: 2048576
                    width: 800
                    height: 600
                    isPrimary: true
                    url: "/static/img/products/prod_42/prod_42_abc123.jpg"
                    uploadedAt: "2023-10-01T12:00:00Z"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "413":
          description: File too large
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
              examples:
                fileTooLarge:
                  value:
                    type: "https://example.com/errors/file-too-large"
                    title: "File Too Large"
                    status: 413
                    detail: "File size exceeds maximum allowed size of 5MB"
                    instance: "/files"
        "415":
          description: Unsupported media type
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
              examples:
                unsupportedMedia:
                  value:
                    type: "https://example.com/errors/unsupported-media-type"
                    title: "Unsupported Media Type"
                    status: 415
                    detail: "Only JPEG, PNG, and WebP images are supported"
                    instance: "/files"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      tags: [Product Images]
      summary: List product images
      responses:
        "200":
          description: Product images list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ProductImage"
              examples:
                success:
                  value:
                    - id: "img_12345678-1234-5678-1234-567812345678"
                      productId: "prod_42"
                      filename: "prod_42_abc123.jpg"
                      originalName: "mouse.jpg"
                      mimeType: "image/jpeg"
                      size: 2048576
                      width: 800
                      height: 600
                      isPrimary: true
                      url: "/static/img/products/prod_42/prod_42_abc123.jpg"
                      uploadedAt: "2023-10-01T12:00:00Z"
        "500":
          $ref: "#/components/responses/InternalError"

  /files/{fileId}:
    parameters:
      - name: fileId
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [Product Images]
      summary: Get product image metadata
      responses:
        "200":
          description: Image metadata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductImage"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Product Images]
      summary: Delete product image (admin)
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Image deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /files/{fileId}/primary:
    parameters:
      - name: fileId
        in: path
        required: true
        schema:
          type: string
    patch:
      tags: [Product Images]
      summary: Set image as primary for product (admin)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Primary image updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductImage"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /cart:
    get:
      tags: [Cart]
      summary: Get current user's cart
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Cart returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CartResponse"
              examples:
                success:
                  value:
                    id: "cart_123"
                    items:
                      - id: "item_1"
                        product_id: "prod_42"
                        name: "Wireless Mouse"
                        quantity: 2
                        unit_price: 29.99
                    total: 59.98
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Cart]
      summary: Clear cart
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Cart cleared
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /cart/items:
    post:
      tags: [Cart]
      summary: Add item to cart
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CartItemRequest"
            examples:
              example:
                value:
                  product_id: "prod_42"
                  quantity: 2
      responses:
        "201":
          description: Item added to cart
          headers:
            Location:
              description: URI of created cart item
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CartItemResponse"
              examples:
                success:
                  value:
                    id: "item_1"
                    product_id: "prod_42"
                    quantity: 2
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /cart/items/{itemId}:
    parameters:
      - $ref: "#/components/parameters/ItemId"
    patch:
      tags: [Cart]
      summary: Update cart item quantity (partial, idempotent)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CartItemUpdate"
      responses:
        "200":
          description: Item updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CartItemResponse"
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Cart]
      summary: Remove cart item
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Item removed
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /orders:
    post:
      tags: [Orders]
      summary: Create order (checkout current cart)
      security:
        - bearerAuth: []
      requestBody:
        description: Optional override (billing/shipping) and payment method token
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderCreate"
            examples:
              example:
                value:
                  billingAddressId: "addr_1"
                  shippingAddressId: "addr_1"
                  paymentMethodToken: "pm_tok_abc"
      responses:
        "201":
          description: Order created
          headers:
            Location:
              description: URI of created order
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
              examples:
                success:
                  value:
                    id: "order_1001"
                    status: "created"
                    total: 59.98
                    billing_address_id: "addr_1"
                    shipping_address_id: "addr_1"
                    items:
                      - product_id: "prod_42"
                        name: "Wireless Mouse"
                        quantity: 2
                        unit_price: 29.99
                    created_at: "2023-10-01T12:00:00Z"
        "400": 
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      tags: [Orders]
      summary: List user's orders (paginated)
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: Orders list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderList"
              examples:
                success:
                  value:
                    items:
                      - id: "order_1001"
                        status: "created"
                        total: 59.98
                        billing_address_id: "addr_1"
                        shipping_address_id: "addr_1"
                        items:
                          - product_id: "prod_42"
                            name: "Wireless Mouse"
                            quantity: 2
                            unit_price: 29.99
                        created_at: "2023-10-01T12:00:00Z"
                    total: 1
                    page: 1
                    page_size: 20
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /orders/{orderId}:
    parameters:
      - $ref: "#/components/parameters/OrderId"
    get:
      tags: [Orders]
      summary: Get order details
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Order details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    ProductId:
      name: productId
      in: path
      required: true
      schema:
        type: string
    ItemId:
      name: itemId
      in: path
      required: true
      schema:
        type: string
    OrderId:
      name: orderId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    AddressId:
      name: addressId
      in: path
      required: true
      schema:
        type: string
    page:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    pageSize:
      name: pageSize
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  responses:
    BadRequest:
      description: Bad request
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
          examples:
            badRequest:
              value:
                type: "https://example.com/errors/bad-request"
                title: "Bad Request"
                status: 400
                detail: "Malformed JSON body."
                instance: "/products"
    Unauthorized:
      description: Unauthorized
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
          examples:
            unauthorized:
              value:
                type: "https://example.com/errors/unauthorized"
                title: "Unauthorized"
                status: 401
                detail: "Missing or invalid Authorization header."
                instance: "/auth/login"
    Forbidden:
      description: Forbidden
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
          examples:
            forbidden:
              value:
                type: "https://example.com/errors/forbidden"
                title: "Forbidden"
                status: 403
                detail: "Insufficient permissions."
                instance: "/products"
    NotFound:
      description: Not Found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
          examples:
            notFound:
              value:
                type: "https://example.com/errors/not-found"
                title: "Not Found"
                status: 404
                detail: "Resource not found."
                instance: "/products/prod_999"
    Conflict:
      description: Conflict
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
          examples:
            conflict:
              value:
                type: "https://example.com/errors/conflict"
                title: "Conflict"
                status: 409
                detail: "Duplicate resource."
                instance: "/auth/register"
    UnprocessableEntity:
      description: Validation error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
          examples:
            validation:
              value:
                type: "https://example.com/errors/validation"
                title: "Validation failed"
                status: 422
                detail: "Field 'email' is required."
                instance: "/auth/register"
    InternalError:
      description: Internal Server Error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
          examples:
            serverError:
              value:
                type: "https://example.com/errors/internal"
                title: "Internal Server Error"
                status: 500
                detail: "Unexpected server error."
                instance: "/orders"

  schemas:
    ProblemDetails:
      title: ProblemDetails
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri
      required:
        - type
        - title
        - status

    RegisterRequest:
      type: object
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        name: { type: string }
      required: [email, password, name]

    LoginRequest:
      type: object
      properties:
        email: { type: string, format: email }
        password: { type: string }
      required: [email, password]

    RefreshTokenRequest:
      type: object
      properties:
        refreshToken: { type: string }
      required: [refreshToken]

    TokenResponse:
      type: object
      properties:
        accessToken: { type: string }
        refreshToken: { type: string }

    AccessTokenResponse:
      type: object
      properties:
        accessToken: { type: string }

    UserResponse:
      type: object
      properties:
        id: { type: string }
        email: { type: string, format: email }
        name: { type: string }

    PasswordChange:
      type: object
      properties:
        oldPassword: { type: string }
        newPassword: { type: string, minLength: 8 }
      required: [oldPassword, newPassword]

    ProductRequest:
      type: object
      properties:
        name: { type: string }
        price: { type: number, minimum: 0 }
        stock: { type: integer, minimum: 0 }
        description: { type: string }
        tags: 
          type: array
          items:
            type: string
        images: 
          type: array
          items:
            type: string
      required: [name, price]

    ProductPatch:
      type: object
      description: "Partial product update — only supplied properties are modified"
      additionalProperties: false
      properties:
        name: { type: string }
        price: { type: number, minimum: 0 }
        stock: { type: integer, minimum: 0 }
        description: { type: string }
        tags: 
          type: array
          items:
            type: string
        images: 
          type: array
          items:
            type: string

    ProductResponse:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        price: { type: number }
        stock: { type: integer }
        description: { type: string }
        tags: 
          type: array
          items:
            type: string
        images:
          type: array
          items:
            type: string
        primaryImageId: 
          type: string
          nullable: true
        created_at: 
          type: string
          format: date-time
        updated_at: 
          type: string
          format: date-time

    ProductList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/ProductResponse"
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }

    ProductImage:
      type: object
      properties:
        id:
          type: string
          format: uuid
        productId:
          type: string
        filename:
          type: string
          description: Server-generated filename
        originalName:
          type: string
          description: Original client filename
        mimeType:
          type: string
          enum: [image/jpeg, image/png, image/webp]
        size:
          type: integer
          description: File size in bytes
          minimum: 1
        width:
          type: integer
          description: Image width in pixels
          minimum: 1
        height:
          type: integer
          description: Image height in pixels
          minimum: 1
        isPrimary:
          type: boolean
        url:
          type: string
          format: uri
          description: Public URL to access the image
        uploadedAt:
          type: string
          format: date-time
      required:
        - id
        - productId
        - filename
        - mimeType
        - size
        - width
        - height
        - isPrimary
        - url
        - uploadedAt

    ProductImageList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/ProductImage"
        total: { type: integer }

    InventoryUpdate:
      type: object
      properties:
        stock: { type: integer, minimum: 0 }
      required: [stock]

    InventoryResponse:
      type: object
      properties:
        id: { type: string }
        stock: { type: integer }

    CartItemRequest:
      type: object
      properties:
        product_id: { type: string }
        quantity: { type: integer, minimum: 1 }
      required: [product_id, quantity]

    CartItemUpdate:
      type: object
      properties:
        quantity: { type: integer, minimum: 1 }
      required: [quantity]

    CartItemResponse:
      type: object
      properties:
        id: { type: string }
        product_id: { type: string }
        name: { type: string }
        quantity: { type: integer }
        unit_price: { type: number }

    CartResponse:
      type: object
      properties:
        id: { type: string }
        items:
          type: array
          items:
            $ref: "#/components/schemas/CartItemResponse"
        total: { type: number }

    OrderCreate:
      type: object
      properties:
        billingAddressId: { type: string }
        shippingAddressId: { type: string }
        paymentMethodToken: { type: string }

    OrderItem:
      type: object
      properties:
        product_id: { type: string }
        name: { type: string }
        quantity: { type: integer }
        unit_price: { type: number }

    OrderResponse:
      type: object
      properties:
        id: { type: string }
        status:
          type: string
          enum: [created, paid, shipped, canceled]
        total: { type: number }
        billing_address_id: { type: string }
        shipping_address_id: { type: string }
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"
        created_at: { type: string, format: date-time }

    OrderList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderResponse"
        total: { type: integer }
        page: { type: integer }
        page_size: { type: integer }

    ProfileUpdate:
      type: object
      properties:
        name: { type: string }
        phone: { type: string }

    AddressRequest:
      type: object
      properties:
        line: { type: string }
        city: { type: string }
        postalCode: { type: string }
        country: { type: string }
      required: [line, city, postalCode, country]

    AddressResponse:
      allOf:
        - $ref: "#/components/schemas/AddressRequest"
        - type: object
          properties:
            id: { type: string }